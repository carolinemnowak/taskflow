
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Taskflow â€” A Caroline Nowak Voice Task Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e10;
    --surface: #18181c;
    --surface2: #222228;
    --border: #2e2e38;
    --accent: #c8f060;
    --accent-dim: #a8cf40;
    --text: #f0f0ec;
    --text-muted: #7a7a88;
    --text-subtle: #4a4a58;
    --urgent: #ff6b4a;
    --high: #ffb347;
    --medium: #c8f060;
    --low: #5a9fd4;
    --done: #3a3a48;
    --radius: 14px;
    --radius-sm: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    min-height: 100vh;
    max-width: 480px;
    margin: 0 auto;
    padding: 0 0 130px 0;
    position: relative;
  }
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.5;
  }

  /* Header */
  .header { padding: 28px 20px 0; position: relative; z-index: 1; }
  .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
  .logo { font-family: 'Instrument Serif', serif; font-size: 28px; line-height: 1; color: var(--text); letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .header-actions { display: flex; gap: 8px; align-items: center; }
  .date-chip { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 5px 12px; font-size: 11px; color: var(--text-muted); letter-spacing: 0.5px; }
  .icon-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); transition: all 0.15s; }
  .icon-btn:active { background: var(--surface2); color: var(--accent); }
  .icon-btn.active { border-color: var(--accent); color: var(--accent); }

  .stats-row { display: flex; gap: 8px; margin-top: 16px; }
  .stat { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; }
  .stat-num { font-family: 'Instrument Serif', serif; font-size: 22px; line-height: 1; color: var(--accent); }
  .stat-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; letter-spacing: 0.5px; text-transform: uppercase; }

  /* Sort/Group bar */
  .controls-row { display: flex; gap: 6px; padding: 12px 20px 0; position: relative; z-index: 1; align-items: center; }
  .control-chip { flex-shrink: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 5px 12px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 5px; }
  .control-chip.active { border-color: var(--accent); color: var(--accent); }
  .control-chip svg { width: 10px; height: 10px; }
  .spacer { flex: 1; }

  /* Filter tabs */
  .filter-row { display: flex; gap: 6px; padding: 10px 20px 0; overflow-x: auto; scrollbar-width: none; position: relative; z-index: 1; }
  .filter-row::-webkit-scrollbar { display: none; }
  .filter-btn { flex-shrink: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 6px 14px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); cursor: pointer; transition: all 0.15s; letter-spacing: 0.3px; }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #0e0e10; font-weight: 500; }

  /* Task list */
  .tasks-section { padding: 16px 20px 0; position: relative; z-index: 1; }
  .group-header { font-size: 10px; color: var(--text-subtle); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; margin-top: 16px; padding-left: 2px; display: flex; align-items: center; gap: 8px; }
  .group-header:first-child { margin-top: 0; }
  .group-header::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .group-count { background: var(--surface2); border-radius: 10px; padding: 1px 7px; font-size: 10px; color: var(--text-subtle); }

  .task-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; position: relative; overflow: hidden; animation: slideIn 0.25s ease; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .task-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; border-radius: 3px 0 0 3px; }
  .task-card.urgent::before { background: var(--urgent); }
  .task-card.high::before { background: var(--high); }
  .task-card.medium::before { background: var(--medium); }
  .task-card.low::before { background: var(--low); }
  .task-card.done { opacity: 0.45; }
  .task-card.done::before { background: var(--done); }
  .task-card:active { transform: scale(0.98); }

  .task-top { display: flex; align-items: flex-start; gap: 10px; }
  .task-check { width: 18px; height: 18px; border-radius: 50%; border: 1.5px solid var(--border); flex-shrink: 0; margin-top: 1px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
  .task-card.urgent .task-check { border-color: var(--urgent); }
  .task-card.high .task-check { border-color: var(--high); }
  .task-card.medium .task-check { border-color: var(--medium); }
  .task-card.low .task-check { border-color: var(--low); }
  .task-card.done .task-check { background: var(--done); border-color: var(--done); }
  .task-check svg { width: 10px; height: 10px; opacity: 0; transition: opacity 0.15s; }
  .task-card.done .task-check svg { opacity: 1; }
  .task-name { flex: 1; font-size: 13px; line-height: 1.4; color: var(--text); }
  .task-card.done .task-name { text-decoration: line-through; color: var(--text-muted); }
  .task-meta { display: flex; align-items: center; gap: 8px; margin-top: 8px; padding-left: 28px; flex-wrap: wrap; }
  .task-due { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
  .task-due.overdue { color: var(--urgent); }
  .task-due.today { color: var(--high); }
  .priority-tag { font-size: 10px; letter-spacing: 0.5px; text-transform: uppercase; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
  .priority-tag.urgent { background: rgba(255,107,74,0.15); color: var(--urgent); }
  .priority-tag.high { background: rgba(255,179,71,0.15); color: var(--high); }
  .priority-tag.medium { background: rgba(200,240,96,0.15); color: var(--medium); }
  .priority-tag.low { background: rgba(90,159,212,0.15); color: var(--low); }
  .task-delete { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--text-subtle); cursor: pointer; border-radius: 6px; transition: all 0.15s; flex-shrink: 0; }
  .task-delete:active { background: rgba(255,107,74,0.15); color: var(--urgent); }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-subtle); }
  .empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.5; }
  .empty-text { font-family: 'Instrument Serif', serif; font-size: 18px; color: var(--text-muted); margin-bottom: 6px; }
  .empty-sub { font-size: 12px; color: var(--text-subtle); line-height: 1.5; }

  /* Input area */
  .voice-area { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; padding: 12px 20px 32px; background: linear-gradient(to top, var(--bg) 70%, transparent); z-index: 10; }
  .input-row { display: flex; gap: 8px; align-items: center; }
  .task-text-input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; font-family: 'DM Mono', monospace; font-size: 14px; color: var(--text); outline: none; transition: border-color 0.15s; -webkit-appearance: none; }
  .task-text-input:focus { border-color: var(--accent); }
  .task-text-input::placeholder { color: var(--text-subtle); }
  .submit-btn { width: 50px; height: 50px; background: var(--accent); border: none; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.15s; color: #0e0e10; }
  .submit-btn:active { background: var(--accent-dim); transform: scale(0.96); }
  .input-hint { text-align: center; margin-top: 6px; font-size: 11px; color: var(--text-subtle); }

  /* Sort panel */
  .panel-overlay { position: fixed; inset: 0; background: rgba(14,14,16,0.7); backdrop-filter: blur(6px); z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .panel-overlay.open { opacity: 1; pointer-events: all; }
  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius) var(--radius) 0 0; padding: 20px 20px 36px; width: 100%; max-width: 480px; position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(40px); transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 51; }
  .panel-overlay.open .panel { transform: translateX(-50%) translateY(0); }
  .panel-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 18px; }
  .panel-title { font-size: 11px; color: var(--text-subtle); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; }
  .panel-options { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
  .panel-opt { background: var(--bg); border: 1px solid var(--border); border-radius: 20px; padding: 7px 14px; font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
  .panel-opt.active { border-color: var(--accent); color: var(--accent); background: rgba(200,240,96,0.08); }
  .panel-divider { height: 1px; background: var(--border); margin: 4px 0 16px; }
  .order-row { display: flex; gap: 6px; }
  .order-btn { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 9px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 6px; }
  .order-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(200,240,96,0.08); }

  /* Notification panel */
  .notif-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .notif-label { font-size: 12px; color: var(--text-muted); }
  .notif-sub { font-size: 11px; color: var(--text-subtle); margin-top: 2px; }
  .toggle { width: 40px; height: 22px; background: var(--border); border-radius: 11px; cursor: pointer; position: relative; transition: background 0.2s; flex-shrink: 0; }
  .toggle.on { background: var(--accent); }
  .toggle::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: transform 0.2s; }
  .toggle.on::after { transform: translateX(18px); }
  .time-input { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 12px; font-family: 'DM Mono', monospace; font-size: 13px; color: var(--text); outline: none; transition: border-color 0.15s; }
  .time-input:focus { border-color: var(--accent); }
  .notif-status { font-size: 11px; padding: 8px 12px; border-radius: var(--radius-sm); margin-top: 8px; }
  .notif-status.ok { background: rgba(200,240,96,0.1); color: var(--accent); }
  .notif-status.warn { background: rgba(255,107,74,0.1); color: var(--urgent); }

  /* Confirm Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(14,14,16,0.85); backdrop-filter: blur(8px); z-index: 100; display: flex; align-items: flex-end; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius) var(--radius) 0 0; padding: 24px 20px 40px; width: 100%; max-width: 480px; transform: translateY(40px); transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }
  .modal-title { font-family: 'Instrument Serif', serif; font-size: 20px; margin-bottom: 4px; }
  .modal-sub { font-size: 11px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; font-style: italic; }
  .form-group { margin-bottom: 14px; }
  .form-label { font-size: 10px; color: var(--text-muted); letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 6px; display: block; }
  .form-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; font-family: 'DM Mono', monospace; font-size: 13px; color: var(--text); outline: none; transition: border-color 0.15s; }
  .form-input:focus { border-color: var(--accent); }
  .priority-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
  .priority-option { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 4px; text-align: center; cursor: pointer; transition: all 0.15s; font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.3px; color: var(--text-muted); }
  .priority-option.selected.urgent { border-color: var(--urgent); color: var(--urgent); background: rgba(255,107,74,0.1); }
  .priority-option.selected.high { border-color: var(--high); color: var(--high); background: rgba(255,179,71,0.1); }
  .priority-option.selected.medium { border-color: var(--medium); color: var(--medium); background: rgba(200,240,96,0.1); }
  .priority-option.selected.low { border-color: var(--low); color: var(--low); background: rgba(90,159,212,0.1); }
  .modal-actions { display: flex; gap: 8px; margin-top: 20px; }
  .btn-cancel { flex: 1; background: transparent; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
  .btn-add { flex: 2; background: var(--accent); border: none; border-radius: var(--radius-sm); padding: 12px; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; color: #0e0e10; cursor: pointer; transition: all 0.15s; }
  .btn-add:active { background: var(--accent-dim); }
  .btn-cancel:active { background: var(--surface2); }

  .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-80px); background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 10px 16px; font-size: 12px; color: var(--text-muted); z-index: 200; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div style="display:flex;align-items:center;gap:6px;">
      <div class="logo">Task<span>flow</span></div>
      <div style="font-size:10px;color:var(--text);letter-spacing:0.3px;line-height:1.5;">A Caroline Nowak<br>Voice Task Manager</div>
    </div>
    <div class="header-actions">
      <div class="date-chip" id="dateChip"></div>
      <div class="icon-btn" onclick="openNotifPanel()" title="Notifications" id="notifBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
      </div>
    </div>
  </div>
  <div class="stats-row">
    <div class="stat"><div class="stat-num" id="statTotal">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-num" id="statToday">0</div><div class="stat-label">Due Today</div></div>
    <div class="stat"><div class="stat-num" id="statDone">0</div><div class="stat-label">Done</div></div>
  </div>
</div>

<!-- Sort & Group controls -->
<div class="controls-row">
  <div class="control-chip" id="sortChip" onclick="openSortPanel()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
    <span id="sortLabel">Sort: Due Date</span>
  </div>
  <div class="control-chip" id="groupChip" onclick="openGroupPanel()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    <span id="groupLabel">Group: None</span>
  </div>
</div>

<!-- Filter tabs -->
<div class="filter-row">
  <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
  <button class="filter-btn" onclick="setFilter('urgent', this)">ðŸ”´ Urgent</button>
  <button class="filter-btn" onclick="setFilter('high', this)">ðŸŸ¡ High</button>
  <button class="filter-btn" onclick="setFilter('medium', this)">ðŸŸ¢ Medium</button>
  <button class="filter-btn" onclick="setFilter('low', this)">ðŸ”µ Low</button>
  <button class="filter-btn" onclick="setFilter('done', this)">âœ“ Done</button>
</div>

<div class="tasks-section" id="taskList"></div>

<!-- Input area -->
<div class="voice-area">
  <div class="input-row">
    <input type="text" id="taskTextInput" class="task-text-input" placeholder="Type or use ðŸŽ¤ on keyboardâ€¦" autocomplete="off" autocorrect="off" spellcheck="false" onkeydown="if(event.key==='Enter')submitTextTask()">
    <button class="submit-btn" onclick="submitTextTask()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18">
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
  <div class="input-hint">Tap the field â†’ tap ðŸŽ¤ on your keyboard to dictate</div>
</div>

<!-- Sort Panel -->
<div class="panel-overlay" id="sortPanel" onclick="closePanels(event)">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="panel-title">Sort by</div>
    <div class="panel-options" id="sortOptions">
      <div class="panel-opt active" data-sort="dueDate" onclick="setSort('dueDate',this)">Due Date</div>
      <div class="panel-opt" data-sort="priority" onclick="setSort('priority',this)">Priority</div>
      <div class="panel-opt" data-sort="name" onclick="setSort('name',this)">Name</div>
      <div class="panel-opt" data-sort="created" onclick="setSort('created',this)">Date Created</div>
    </div>
    <div class="panel-divider"></div>
    <div class="panel-title">Order</div>
    <div class="order-row">
      <button class="order-btn active" id="orderAsc" onclick="setOrder('asc')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
        Ascending
      </button>
      <button class="order-btn" id="orderDesc" onclick="setOrder('desc')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
        Descending
      </button>
    </div>
  </div>
</div>

<!-- Group Panel -->
<div class="panel-overlay" id="groupPanel" onclick="closePanels(event)">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="panel-title">Group by</div>
    <div class="panel-options" id="groupOptions">
      <div class="panel-opt active" data-group="none" onclick="setGroup('none',this)">None</div>
      <div class="panel-opt" data-group="priority" onclick="setGroup('priority',this)">Priority</div>
      <div class="panel-opt" data-group="dueDate" onclick="setGroup('dueDate',this)">Due Date</div>
    </div>
  </div>
</div>

<!-- Notification Panel -->
<div class="panel-overlay" id="notifPanel" onclick="closePanels(event)">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="panel-title">Notifications</div>

    <div class="notif-row">
      <div>
        <div class="notif-label">Morning digest</div>
        <div class="notif-sub">Daily summary at 7:00 AM ET every morning</div>
      </div>
      <div class="toggle" id="digestToggle" onclick="toggleDigest()"></div>
    </div>

    <div class="panel-divider"></div>

    <div class="notif-row">
      <div>
        <div class="notif-label">Overdue alerts</div>
        <div class="notif-sub">Alerts at the exact moment a task becomes overdue</div>
      </div>
      <div class="toggle" id="overdueToggle" onclick="toggleOverdue()"></div>
    </div>

    <div class="panel-divider"></div>

    <div class="notif-row">
      <div>
        <div class="notif-label">Reminders</div>
        <div class="notif-sub">Alert 30 minutes before tasks with a set time</div>
      </div>
      <div class="toggle" id="reminderToggle" onclick="toggleReminder()"></div>
    </div>

    <div id="notifStatus" class="notif-status" style="display:none"></div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Confirm task</div>
    <div class="modal-sub" id="transcriptDisplay"></div>
    <div class="form-group">
      <label class="form-label">Task</label>
      <input type="text" class="form-input" id="taskNameInput" placeholder="Task description">
    </div>
    <div class="form-group">
      <label class="form-label">Due date & time</label>
      <div style="display:flex;gap:8px;">
        <input type="date" class="form-input" id="taskDateInput" style="flex:2">
        <input type="time" class="form-input" id="taskTimeInput" style="flex:1" placeholder="--:--">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Priority</label>
      <div class="priority-grid">
        <div class="priority-option urgent" data-priority="urgent" onclick="selectPriority('urgent')">Urgent</div>
        <div class="priority-option high" data-priority="high" onclick="selectPriority('high')">High</div>
        <div class="priority-option medium" data-priority="medium" onclick="selectPriority('medium')">Medium</div>
        <div class="priority-option low" data-priority="low" onclick="selectPriority('low')">Low</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-add" onclick="addTaskFromModal()">Add task</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tasks = JSON.parse(localStorage.getItem('taskflow_tasks') || '[]');
let currentFilter = 'all';
let selectedPriority = 'medium';
let sortBy = localStorage.getItem('tf_sort') || 'dueDate';
let sortOrder = localStorage.getItem('tf_order') || 'asc';
let groupBy = localStorage.getItem('tf_group') || 'none';
let notifSettings = JSON.parse(localStorage.getItem('tf_notif') || '{"digest":false,"overdue":false,"reminder":false}');

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  updateDateChip();
  renderTasks();
  updateSortGroupLabels();
  updateNotifUI();
  scheduleNotifications();
}

function updateDateChip() {
  const opts = { weekday: 'short', month: 'short', day: 'numeric' };
  document.getElementById('dateChip').textContent = new Date().toLocaleDateString('en-US', opts).toUpperCase();
}

// â”€â”€â”€ Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTasks();
}

// â”€â”€â”€ Sort / Group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSort(val, el) {
  sortBy = val;
  localStorage.setItem('tf_sort', val);
  document.querySelectorAll('#sortOptions .panel-opt').forEach(o => o.classList.remove('active'));
  el.classList.add('active');
  updateSortGroupLabels();
  renderTasks();
}

function setOrder(val) {
  sortOrder = val;
  localStorage.setItem('tf_order', val);
  document.getElementById('orderAsc').classList.toggle('active', val === 'asc');
  document.getElementById('orderDesc').classList.toggle('active', val === 'desc');
  renderTasks();
}

function setGroup(val, el) {
  groupBy = val;
  localStorage.setItem('tf_group', val);
  document.querySelectorAll('#groupOptions .panel-opt').forEach(o => o.classList.remove('active'));
  el.classList.add('active');
  updateSortGroupLabels();
  closePanels();
  renderTasks();
}

function updateSortGroupLabels() {
  const sortNames = { dueDate: 'Due Date', priority: 'Priority', name: 'Name', created: 'Created' };
  const groupNames = { none: 'None', priority: 'Priority', dueDate: 'Due Date' };
  document.getElementById('sortLabel').textContent = 'Sort: ' + (sortNames[sortBy] || sortBy);
  document.getElementById('groupLabel').textContent = 'Group: ' + (groupNames[groupBy] || groupBy);
  document.getElementById('sortChip').classList.toggle('active', sortBy !== 'dueDate' || sortOrder !== 'asc');
  document.getElementById('groupChip').classList.toggle('active', groupBy !== 'none');
  // Sync panel UI
  document.querySelectorAll('#sortOptions .panel-opt').forEach(o => o.classList.toggle('active', o.dataset.sort === sortBy));
  document.querySelectorAll('#groupOptions .panel-opt').forEach(o => o.classList.toggle('active', o.dataset.group === groupBy));
  document.getElementById('orderAsc').classList.toggle('active', sortOrder === 'asc');
  document.getElementById('orderDesc').classList.toggle('active', sortOrder === 'desc');
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRIORITY_ORDER = { urgent: 0, high: 1, medium: 2, low: 3 };

function sortTasks(arr) {
  return [...arr].sort((a, b) => {
    let cmp = 0;
    if (sortBy === 'dueDate') {
      const ad = a.dueDate ? new Date(a.dueDate) : null;
      const bd = b.dueDate ? new Date(b.dueDate) : null;
      if (ad && bd) cmp = ad - bd;
      else if (ad) cmp = -1;
      else if (bd) cmp = 1;
      else cmp = PRIORITY_ORDER[a.priority] - PRIORITY_ORDER[b.priority];
    } else if (sortBy === 'priority') {
      cmp = PRIORITY_ORDER[a.priority] - PRIORITY_ORDER[b.priority];
    } else if (sortBy === 'name') {
      cmp = a.name.localeCompare(b.name);
    } else if (sortBy === 'created') {
      cmp = new Date(a.createdAt) - new Date(b.createdAt);
    }
    // Priority sort is always descending (urgent first); others respect sortOrder
    if (sortBy === 'priority') return cmp; // always urgentâ†’low
    return sortOrder === 'desc' ? -cmp : cmp;
  });
}

function getGroupKey(task) {
  if (groupBy === 'priority') return task.priority;
  if (groupBy === 'dueDate') {
    if (!task.dueDate) return 'no-date';
    const today = new Date(); today.setHours(0,0,0,0);
    const d = new Date(task.dueDate + 'T00:00:00'); d.setHours(0,0,0,0);
    const diff = Math.round((d - today) / 86400000);
    if (diff < 0) return 'overdue';
    if (diff === 0) return 'today';
    if (diff <= 7) return 'this-week';
    return 'later';
  }
  return 'all';
}

const GROUP_LABELS = {
  urgent: 'ðŸ”´ Urgent', high: 'ðŸŸ¡ High', medium: 'ðŸŸ¢ Medium', low: 'ðŸ”µ Low',
  overdue: 'âš ï¸ Overdue', today: 'ðŸ“… Today', 'this-week': 'ðŸ“† This Week', later: 'ðŸ—“ Later', 'no-date': 'âˆž No Date',
  all: 'Tasks'
};

const GROUP_ORDER = {
  priority: ['urgent','high','medium','low'],
  dueDate: ['overdue','today','this-week','later','no-date'],
  none: ['all']
};

function renderTasks() {
  const list = document.getElementById('taskList');
  const today = new Date(); today.setHours(0,0,0,0);

  let filtered = tasks.filter(t => {
    if (currentFilter === 'all') return !t.done;
    if (currentFilter === 'done') return t.done;
    return t.priority === currentFilter && !t.done;
  });

  // Stats
  const active = tasks.filter(t => !t.done);
  const todayTasks = active.filter(t => {
    if (!t.dueDate) return false;
    const d = new Date(t.dueDate + 'T00:00:00'); d.setHours(0,0,0,0);
    return d.getTime() === today.getTime();
  });
  document.getElementById('statTotal').textContent = active.length;
  document.getElementById('statToday').textContent = todayTasks.length;
  document.getElementById('statDone').textContent = tasks.filter(t => t.done).length;

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ¦</div><div class="empty-text">Nothing here</div><div class="empty-sub">Tap the input below and speak or type a task.</div></div>`;
    return;
  }

  const sorted = sortTasks(filtered);

  // Group
  if (groupBy === 'none') {
    list.innerHTML = sorted.map(t => taskCardHTML(t, today)).join('');
    return;
  }

  // Build groups
  const groups = {};
  sorted.forEach(t => {
    const key = getGroupKey(t);
    if (!groups[key]) groups[key] = [];
    groups[key].push(t);
  });

  const order = GROUP_ORDER[groupBy] || Object.keys(groups);
  let html = '';
  order.forEach(key => {
    if (!groups[key] || groups[key].length === 0) return;
    html += `<div class="group-header">${GROUP_LABELS[key] || key} <span class="group-count">${groups[key].length}</span></div>`;
    html += groups[key].map(t => taskCardHTML(t, today)).join('');
  });
  // Any keys not in the predefined order
  Object.keys(groups).forEach(key => {
    if (!order.includes(key)) {
      html += `<div class="group-header">${GROUP_LABELS[key] || key} <span class="group-count">${groups[key].length}</span></div>`;
      html += groups[key].map(t => taskCardHTML(t, today)).join('');
    }
  });

  list.innerHTML = html;
}

function taskCardHTML(task, today) {
  const dueStr = formatDue(task.dueDate, today, task.dueTime);
  const dueClass = dueStr.overdue ? 'overdue' : dueStr.today ? 'today' : '';
  return `
  <div class="task-card ${task.done ? 'done' : task.priority}" onclick="toggleDone('${task.id}')">
    <div class="task-top">
      <div class="task-check">
        <svg viewBox="0 0 10 10" fill="none" stroke="${task.done ? '#f0f0ec' : 'currentColor'}" stroke-width="2">
          <polyline points="1.5,5 4,7.5 8.5,2.5"/>
        </svg>
      </div>
      <div class="task-name">${escHtml(task.name)}</div>
      <div class="task-delete" onclick="deleteTask(event,'${task.id}')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </div>
    </div>
    <div class="task-meta">
      ${dueStr.text ? `<div class="task-due ${dueClass}">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        ${dueStr.text}
      </div>` : ''}
      ${!task.done ? `<div class="priority-tag ${task.priority}">${task.priority}</div>` : ''}
    </div>
  </div>`;
}

function formatDue(dateStr, today, timeStr) {
  if (!dateStr) return { text: '', overdue: false, today: false };
  const d = new Date(dateStr + 'T00:00:00'); d.setHours(0,0,0,0);
  const diff = Math.round((d - today) / 86400000);
  const timeSuffix = timeStr ? ' Â· ' + fmtTime(timeStr) : '';
  if (diff < 0) return { text: `${Math.abs(diff)}d overdue${timeSuffix}`, overdue: true, today: false };
  if (diff === 0) return { text: `Today${timeSuffix}`, overdue: false, today: true };
  if (diff === 1) return { text: `Tomorrow${timeSuffix}`, overdue: false, today: false };
  if (diff < 7) return { text: `${diff} days${timeSuffix}`, overdue: false, today: false };
  return { text: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + timeSuffix, overdue: false, today: false };
}

function fmtTime(t) {
  if (!t) return '';
  const [h, m] = t.split(':').map(Number);
  const ampm = h >= 12 ? 'pm' : 'am';
  const hour = h % 12 || 12;
  return `${hour}:${m.toString().padStart(2,'0')}${ampm}`;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ Task actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDone(id) {
  const t = tasks.find(t => t.id === id);
  if (t) { t.done = !t.done; saveTasks(); renderTasks(); }
}

function deleteTask(e, id) {
  e.stopPropagation();
  tasks = tasks.filter(t => t.id !== id);
  saveTasks(); renderTasks();
  showToast('Task deleted');
}

function saveTasks() { localStorage.setItem('taskflow_tasks', JSON.stringify(tasks)); }

// â”€â”€â”€ Submit / Parse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitTextTask() {
  const input = document.getElementById('taskTextInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = ''; input.blur();
  parseTask(text);
}

function parseTask(transcript) {
  try {
    const parsed = parseTaskLocally(transcript);
    openConfirmModal(transcript, parsed.name, parsed.dueDate, parsed.priority, parsed.dueTime);
  } catch(err) {
    openConfirmModal(transcript, transcript, null, 'medium', null);
  }
}

// â”€â”€â”€ Local NLP Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTaskLocally(transcript) {
  const lower = transcript.toLowerCase();
  const today = new Date(); today.setHours(0,0,0,0);
  let dueDate = null;

  const datePatterns = [
    { re: /\bon\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/, fn: m => nextWeekday(m[1]) },
    { re: /\bon\s+(?:the\s+)?(\d{1,2})(?:st|nd|rd|th)?\b/, fn: m => dateThisMonth(parseInt(m[1])) },
    { re: /\bon\s+(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:tember)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})\b/, fn: m => dateFromMonthDay(m[1], parseInt(m[2])) },
    { re: /\btoday\b/, fn: () => addDays(today, 0) },
    { re: /\btomorrow\b/, fn: () => addDays(today, 1) },
    { re: /\bday after tomorrow\b/, fn: () => addDays(today, 2) },
    { re: /\bnext week\b/, fn: () => addDays(today, 7) },
    { re: /\bin (\d+) days?\b/, fn: m => addDays(today, parseInt(m[1])) },
    { re: /\bin (\d+) weeks?\b/, fn: m => addDays(today, parseInt(m[1]) * 7) },
    { re: /\ba week from (?:now|today)\b/, fn: () => addDays(today, 7) },
    { re: /\bend of (?:the )?week\b/, fn: () => nextWeekday('friday') },
    { re: /\bend of (?:the )?month\b/, fn: () => endOfMonth(today) },
    { re: /\bthis\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/, fn: m => thisWeekday(m[1]) },
    { re: /\bnext\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/, fn: m => nextWeekday(m[1], true) },
    { re: /\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/, fn: m => nextWeekday(m[1]) },
  ];

  for (const { re, fn } of datePatterns) {
    const m = lower.match(re);
    if (m) { dueDate = fn(m); break; }
  }

  let priority = 'medium';
  const urgentWords = /\b(asap|urgent|urgently|immediately|critical|emergency|right away|right now|today)\b/;
  const highWords = /\b(important|high priority|soon|this week|by friday|by end of week|must|need to)\b/;
  const lowWords = /\b(whenever|someday|eventually|no rush|low priority|at some point|later|when i can)\b/;

  if (urgentWords.test(lower) || (dueDate && isSameDay(dueDate, today)) || (dueDate && isSameDay(dueDate, addDays(today, 1)))) {
    priority = 'urgent';
  } else if (highWords.test(lower) || (dueDate && daysBetween(today, dueDate) <= 7)) {
    priority = 'high';
  } else if (lowWords.test(lower)) {
    priority = 'low';
  }

  let name = transcript;
  const removePatterns = [
    /\b(by|before|on|due|until|for)\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/gi,
    /\b(by|before|on|due|until|for)\s+(next|this)\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/gi,
    /\b(by|before|on|due|until)\s+(tomorrow|today|end of (?:the )?week|end of (?:the )?month)\b/gi,
    /\bin \d+ (days?|weeks?)\b/gi,
    /\b(next week|this week|by friday|end of week|end of month|day after tomorrow)\b/gi,
    /\b(asap|urgently|right away|right now)\b/gi,
    /\b(?:at|by)\s+\d{1,2}(?::\d{2})?\s*(?:am|pm)\b/gi,
    /\b(?:at|by)\s+noon\b/gi,
    /\b(?:at|by)\s+midnight\b/gi,
    /\b(?:at)\s+\d{1,2}\b/gi,
    /\bi need to\b/gi, /\bi have to\b/gi, /\bi should\b/gi, /\bremind me to\b/gi,
    /\bdon't forget to\b/gi, /\bmake sure to\b/gi, /\bplease\b/gi,
    /\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:tember)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+\d{1,2}(?:st|nd|rd|th)?\b/gi,
  ];
  for (const re of removePatterns) name = name.replace(re, '');
  name = name.replace(/\s+/g, ' ').replace(/^[\s,.-]+|[\s,.-]+$/g, '').trim();
  if (name) name = name.charAt(0).toUpperCase() + name.slice(1);
  if (!name) name = transcript;

  return { name, dueDate: dueDate ? fmtDate(dueDate) : null, dueTime: extractTime(lower), priority };
}

function extractTime(lower) {
  // Match patterns like: 3pm, 3:30pm, 3:30 pm, at 3, at 3pm, at noon, at midnight, by 5pm
  const timeRe = /\b(?:at|by)?\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)\b/i;
  const noonRe = /\b(?:at\s+)?noon\b/;
  const midnightRe = /\b(?:at\s+)?midnight\b/;
  const bareHourRe = /\b(?:at)\s+(\d{1,2})\b(?!\s*(?:am|pm|:))/i;

  if (noonRe.test(lower)) return '12:00';
  if (midnightRe.test(lower)) return '00:00';

  let m = lower.match(timeRe);
  if (m) {
    let h = parseInt(m[1]);
    const min = m[2] ? parseInt(m[2]) : 0;
    const ampm = m[3].toLowerCase();
    if (ampm === 'pm' && h !== 12) h += 12;
    if (ampm === 'am' && h === 12) h = 0;
    return `${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`;
  }

  m = lower.match(bareHourRe);
  if (m) {
    const h = parseInt(m[1]);
    // Assume PM for hours 1-7, AM for 8-11
    const adjusted = (h >= 1 && h <= 7) ? h + 12 : h;
    return `${adjusted.toString().padStart(2,'0')}:00`;
  }

  return null;
}

// â”€â”€ Date helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addDays(d, n) { const r = new Date(d); r.setDate(r.getDate() + n); return r; }
function fmtDate(d) { return d.toISOString().split('T')[0]; }
function isSameDay(a, b) { return a.toDateString() === b.toDateString(); }
function daysBetween(a, b) { return Math.round((b - a) / 86400000); }
const WEEKDAYS = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
function nextWeekday(name, forceNext = false) {
  const today = new Date(); today.setHours(0,0,0,0);
  const target = WEEKDAYS.indexOf(name.toLowerCase());
  if (target === -1) return null;
  let diff = target - today.getDay();
  if (diff <= 0 || forceNext) diff += 7;
  return addDays(today, diff);
}
function thisWeekday(name) {
  const today = new Date(); today.setHours(0,0,0,0);
  const target = WEEKDAYS.indexOf(name.toLowerCase());
  let diff = target - today.getDay();
  if (diff <= 0) diff += 7;
  return addDays(today, diff);
}
function dateThisMonth(day) {
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(today.getFullYear(), today.getMonth(), day);
  if (d < today) d.setMonth(d.getMonth() + 1);
  return d;
}
function dateFromMonthDay(monthStr, day) {
  const months = { jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,january:0,february:1,march:2,april:3,june:5,july:6,august:7,september:8,october:9,november:10,december:11 };
  const today = new Date(); today.setHours(0,0,0,0);
  const m = months[monthStr.slice(0,3).toLowerCase()];
  if (m === undefined) return null;
  let d = new Date(today.getFullYear(), m, day);
  if (d < today) d.setFullYear(d.getFullYear() + 1);
  return d;
}
function endOfMonth(d) { return new Date(d.getFullYear(), d.getMonth() + 1, 0); }

// â”€â”€â”€ Confirm Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openConfirmModal(transcript, name, dueDate, priority, dueTime) {
  document.getElementById('transcriptDisplay').textContent = `"${transcript}"`;
  document.getElementById('taskNameInput').value = name || '';
  document.getElementById('taskDateInput').value = dueDate || '';
  document.getElementById('taskTimeInput').value = dueTime || '';
  selectPriority(priority || 'medium');
  document.getElementById('confirmModal').classList.add('open');
}

function closeModal() { document.getElementById('confirmModal').classList.remove('open'); }

function selectPriority(p) {
  selectedPriority = p;
  document.querySelectorAll('.priority-option').forEach(el => el.classList.toggle('selected', el.dataset.priority === p));
}

function addTaskFromModal() {
  const name = document.getElementById('taskNameInput').value.trim();
  if (!name) { showToast('Please enter a task name'); return; }
  tasks.push({
    id: Date.now().toString(36) + Math.random().toString(36).slice(2),
    name,
    dueDate: document.getElementById('taskDateInput').value || null,
    dueTime: document.getElementById('taskTimeInput').value || null,
    priority: selectedPriority,
    done: false,
    createdAt: new Date().toISOString()
  });
  saveTasks();
  closeModal();
  renderTasks();
  showToast('Task added âœ“');
}

// â”€â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSortPanel() { document.getElementById('sortPanel').classList.add('open'); }
function openGroupPanel() { document.getElementById('groupPanel').classList.add('open'); }
function openNotifPanel() { updateNotifUI(); document.getElementById('notifPanel').classList.add('open'); }

function closePanels(e) {
  if (e && e.target !== e.currentTarget) return;
  document.querySelectorAll('.panel-overlay').forEach(p => p.classList.remove('open'));
}

// â”€â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDigest() {
  notifSettings.digest = !notifSettings.digest;
  if (notifSettings.digest) requestNotifPermission(() => { saveNotifSettings(); updateNotifUI(); });
  else { saveNotifSettings(); updateNotifUI(); }
}

function toggleOverdue() {
  notifSettings.overdue = !notifSettings.overdue;
  if (notifSettings.overdue) requestNotifPermission(() => { saveNotifSettings(); updateNotifUI(); });
  else { saveNotifSettings(); updateNotifUI(); }
}

function toggleReminder() {
  notifSettings.reminder = !notifSettings.reminder;
  if (notifSettings.reminder) requestNotifPermission(() => { saveNotifSettings(); updateNotifUI(); });
  else { saveNotifSettings(); updateNotifUI(); }
}

function saveNotifSettings() {
  localStorage.setItem('tf_notif', JSON.stringify(notifSettings));
  scheduleNotifications();
  updateNotifUI();
}

function updateNotifUI() {
  document.getElementById('digestToggle').classList.toggle('on', notifSettings.digest);
  document.getElementById('overdueToggle').classList.toggle('on', notifSettings.overdue);
  document.getElementById('reminderToggle').classList.toggle('on', notifSettings.reminder);

  const statusEl = document.getElementById('notifStatus');
  const anyOn = notifSettings.digest || notifSettings.overdue || notifSettings.reminder;

  if (!anyOn) { statusEl.style.display = 'none'; return; }

  if (!('Notification' in window)) {
    statusEl.style.display = 'block';
    statusEl.className = 'notif-status warn';
    statusEl.textContent = 'âš ï¸ Add to home screen to enable notifications on iPhone.';
  } else if (Notification.permission === 'granted') {
    statusEl.style.display = 'block';
    statusEl.className = 'notif-status ok';
    statusEl.textContent = 'âœ“ Notifications enabled';
    document.getElementById('notifBtn').classList.add('active');
  } else if (Notification.permission === 'denied') {
    statusEl.style.display = 'block';
    statusEl.className = 'notif-status warn';
    statusEl.textContent = 'âš ï¸ Permission denied â€” enable in browser/device settings';
  } else {
    statusEl.style.display = 'block';
    statusEl.className = 'notif-status warn';
    statusEl.textContent = 'Tap a toggle above to grant permission';
  }
}

function requestNotifPermission(cb) {
  if (!('Notification' in window)) { showToast('Add to home screen first'); return; }
  if (Notification.permission === 'granted') { cb(); return; }
  Notification.requestPermission().then(perm => {
    if (perm === 'granted') cb();
    else { showToast('Permission denied'); updateNotifUI(); }
  });
}

function scheduleNotifications() {
  if (window._notifInterval) clearInterval(window._notifInterval);
  const anyOn = notifSettings.digest || notifSettings.overdue || notifSettings.reminder;
  if (!anyOn) return;
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  // Check every minute
  window._notifInterval = setInterval(checkNotifications, 60000);
  checkNotifications();
}

function checkNotifications() {
  const now = new Date();
  const today = new Date(); today.setHours(0,0,0,0);
  const todayKey = today.toISOString().split('T')[0];

  // â”€â”€ 1. Morning digest â€” fires at exactly 7:00 AM ET â”€â”€
  if (notifSettings.digest) {
    // Convert current time to ET (UTC-5 standard, UTC-4 daylight)
    const etOffset = getETOffsetMinutes();
    const etNow = new Date(now.getTime() + etOffset * 60000);
    const etH = etNow.getUTCHours();
    const etM = etNow.getUTCMinutes();
    if (etH === 7 && etM === 0) {
      const lastDigest = localStorage.getItem('tf_last_digest');
      if (lastDigest !== todayKey) {
        const todayTasks = tasks.filter(t => !t.done && t.dueDate === todayKey);
        const overdueTasks = tasks.filter(t => {
          if (t.done || !t.dueDate) return false;
          return new Date(t.dueDate + 'T00:00:00') < today;
        });
        let body = '';
        if (todayTasks.length > 0) body += `${todayTasks.length} task${todayTasks.length > 1 ? 's' : ''} due today. `;
        if (overdueTasks.length > 0) body += `${overdueTasks.length} overdue.`;
        if (!body) body = 'No tasks due today â€” clear day! âœ¨';
        new Notification('Taskflow â€” Good morning â˜€ï¸', { body, icon: '/favicon.ico' });
        localStorage.setItem('tf_last_digest', todayKey);
      }
    }
  }

  // â”€â”€ 2. Overdue alerts â€” fires at the exact due date+time â”€â”€
  if (notifSettings.overdue) {
    tasks.forEach(t => {
      if (t.done || !t.dueDate) return;
      const dueTime = t.dueTime || '00:00'; // default to midnight if no time set
      const taskDt = new Date(t.dueDate + 'T' + dueTime);
      const minsAgo = (now - taskDt) / 60000;
      // Fire within the current minute window (0â€“1 min past due)
      if (minsAgo >= 0 && minsAgo < 1) {
        const notifKey = 'tf_overdue_' + t.id + '_' + t.dueDate;
        if (!localStorage.getItem(notifKey)) {
          new Notification('Taskflow â€” Task overdue', {
            body: t.name + (t.dueTime ? ' Â· was due at ' + fmtTime(t.dueTime) : ' Â· was due today'),
            icon: '/favicon.ico'
          });
          localStorage.setItem(notifKey, '1');
        }
      }
    });
  }

  // â”€â”€ 3. Reminders â€” fires 30 minutes before tasks with a set time â”€â”€
  if (notifSettings.reminder) {
    tasks.forEach(t => {
      if (t.done || !t.dueDate || !t.dueTime) return;
      const taskDt = new Date(t.dueDate + 'T' + t.dueTime);
      const minsUntil = (taskDt - now) / 60000;
      if (minsUntil >= 29 && minsUntil < 30) {
        const notifKey = 'tf_remind_30_' + t.id + '_' + t.dueDate;
        if (!localStorage.getItem(notifKey)) {
          new Notification('Taskflow â€” Due in 30 minutes', {
            body: t.name + ' Â· ' + fmtTime(t.dueTime),
            icon: '/favicon.ico'
          });
          localStorage.setItem(notifKey, '1');
        }
      }
    });
  }
}

// Returns ET offset in minutes from UTC (handles DST automatically)
function getETOffsetMinutes() {
  // ET is UTC-5 (EST) or UTC-4 (EDT)
  // DST in US: second Sunday March â†’ first Sunday November
  const now = new Date();
  const jan = new Date(now.getFullYear(), 0, 1);
  const jul = new Date(now.getFullYear(), 6, 1);
  const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
  const isDST = now.getTimezoneOffset() < stdOffset;
  return isDST ? -4 * 60 : -5 * 60;
}

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€â”€ Modal backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('confirmModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

init();
</script>
</body>
</html>
